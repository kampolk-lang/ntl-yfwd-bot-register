<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>เงินติดล้อ - ระบบลงทะเบียน คุณสู้เราช่วย</title>
  <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/bvfCymDB/Logo-NTL-no-SS-04.jpg" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font: Sarabun -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    /* โลโก้ hero */
    .hero-logo {
      height: clamp(126px, 6vw, 156px);
      width: auto; object-fit: contain; display: block;
    }
    .hero-register { background: #fff; padding-block: clamp(8px, 3vw, 16px); }
    .hero-wrap { display:flex; align-items:center; justify-content:center; padding-inline: clamp(12px, 4vw, 40px); margin-inline:auto; text-align:center; }

    :root {
      --ig-yellow:#f9ce34; --ig-pink:#ee2a7b; --ig-purple:#6228d7; --brand-white:#ffffff;
    }
    body { font-family:'Sarabun', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; background: var(--brand-white); }
    .brand-gradient { background: radial-gradient(circle at 20% 20%, var(--ig-yellow), var(--ig-pink) 45%, var(--ig-purple) 85%); color:#fff; }
    .navbar-brand { font-weight:700; letter-spacing:.2px; }
    .card { border:0; box-shadow:0 10px 24px rgba(0,0,0,.08); border-radius:1rem; }
    .required::after { content:' *'; color:#dc3545; font-weight:700; }
    .spinner-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.7); z-index:1055; backdrop-filter:blur(2px); }
    .form-section-title { font-size:1.1rem; font-weight:600; color:#3b2b8f; margin-bottom:.75rem; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <nav class="navbar navbar-expand-lg brand-gradient">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-1 text-white" href="#">
        <span>ลงทะเบียนตอบรับ คุณสู้เราช่วย</span>
      </a>
      <div class="ms-auto text-white fw-semibold"></div>
    </div>
  </nav>

  <!-- โลโก้เหนือฟอร์ม -->
  <section class="hero-register">
    <div class="container">
      <div class="hero-wrap">
        <img
          src="https://i.postimg.cc/wMpvVyvv/Logo-NTL-no-SS-01.jpg"
          alt="เงินติดล้อ"
          class="hero-logo"
          loading="lazy" decoding="async">
      </div>
    </div>
  </section>

  <main class="container my-4 my-md-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body p-4 p-md-5">

            <h1 class="h4 mb-3">แบบฟอร์มลงทะเบียน</h1>
            <p class="text-secondary mb-4">
              กรอกข้อมูล แล้วกด <strong>Submit</strong>
            </p>

            <div class="form-section-title">ข้อมูลผู้ลงทะเบียน</div>
            <form id="regForm" class="row g-3" novalidate>
              <div class="col-md-6">
                <label class="form-label required">ชื่อ-สกุล</label>
                <input type="text" class="form-control" name="fullName" required placeholder="เช่น สมชาย ใจดี">
              </div>

              <div class="col-md-6">
                <label class="form-label required">เลขที่สัญญา</label>
                <input type="text" class="form-control" name="contractNo" required placeholder="06xxxxxxxxxxxxxxx">
              </div>

              <div class="col-md-6">
                <label class="form-label required">เบอร์โทรสะดวกติดต่อกลับ</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                  <input type="tel" class="form-control" name="phone" required placeholder="เช่น 08x-xxx-xxxx">
                </div>
              </div>

              <div class="col-12 mt-3 form-section-title">พื้นที่ให้บริการและสาขา</div>

              <div class="col-md-6">
                <label class="form-label required">จังหวัด</label>
                <select class="form-select" id="province" required>
                  <option value="">— เลือกจังหวัด —</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required">อำเภอ</label>
                <select class="form-select" id="district" required disabled>
                  <option value="">— เลือกอำเภอ —</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required">ตำบล</label>
                <select class="form-select" id="subdistrict" required disabled>
                  <option value="">— เลือกตำบล —</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required">สาขา</label>
                <select class="form-select" id="branch" required disabled>
                  <option value="">— เลือกสาขา —</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required">วัน เดือน ปี เวลา (ที่สะดวก)</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-calendar2-week"></i></span>
                  <input type="datetime-local" class="form-control" name="preferredDt" id="preferredDt" required step="60">
                </div>
              </div>

              <div class="col-12 d-flex align-items-center gap-3 mt-2">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check2-circle me-1"></i> Submit
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-counterclockwise me-1"></i> ล้างฟอร์ม
                </button>
                <span class="text-muted small"><i class="bi bi-shield-lock"></i></span>
              </div>
            </form>

            <hr class="my-4">

            <!-- แสดง URL Netlify (อัตโนมัติ) -->
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-globe2"></i>
              <span class="small text-muted">
                URL (Netlify): <a id="netlifyUrlLink" href="#" target="_blank" rel="noopener"></a>
              </span>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loading overlay -->
  <div id="spinner" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="mt-3 fw-semibold">กำลังประมวลผล โปรดรอสักครู่…</div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ===== CONFIG (ฝั่งหน้าเว็บ) ===== */
    const API_BASE = '/api'; // Netlify จะ redirect ไปฟังก์ชัน proxy อัตโนมัติ

    /* ===== Elements ===== */
    const el = {
      province: document.getElementById('province'),
      district: document.getElementById('district'),
      subdistrict: document.getElementById('subdistrict'),
      branch: document.getElementById('branch'),
      spinner: document.getElementById('spinner'),
      form: document.getElementById('regForm'),
      preferredDt: document.getElementById('preferredDt'),
      netlifyUrlLink: document.getElementById('netlifyUrlLink'),
    };

    /* ===== Helpers ===== */
    function setLoading(show) { el.spinner.style.display = show ? 'flex' : 'none'; }
    function resetSelect(select, placeholder, disabled=true) {
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = ''; opt.textContent = placeholder;
      select.appendChild(opt);
      select.disabled = disabled;
    }
    function fillSelect(select, items, placeholder) {
      resetSelect(select, placeholder, false);
      items.forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        select.appendChild(o);
      });
    }
    function setMinDateNow() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const minStr = now.toISOString().slice(0,16); // YYYY-MM-DDTHH:mm
      el.preferredDt.setAttribute('min', minStr);
    }

    /* ===== API Calls (ผ่าน Netlify Function) ===== */
    async function apiGet(params) {
      const url = new URL(API_BASE, window.location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      const r = await fetch(url.toString(), { method:'GET' });
      if (!r.ok) throw new Error('API error ' + r.status);
      return r.json();
    }
    async function apiPost(payload) {
      const r = await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('API error ' + r.status);
      return r.json();
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', async () => {
      // แสดง URL Netlify อัตโนมัติ
      el.netlifyUrlLink.textContent = window.location.origin;
      el.netlifyUrlLink.href = window.location.origin;

      setMinDateNow();
      setLoading(true);
      try {
        const provinces = await apiGet({ action:'provinces' });
        fillSelect(el.province, provinces, '— เลือกจังหวัด —');
      } catch (e) {
        alert('โหลดจังหวัดไม่สำเร็จ: ' + (e?.message || e));
      } finally {
        setLoading(false);
      }
    });

    /* ===== Cascading selections ===== */
    el.province.addEventListener('change', async (e) => {
      const pv = e.target.value;
      resetSelect(el.district, '— เลือกอำเภอ —');
      resetSelect(el.subdistrict, '— เลือกตำบล —');
      resetSelect(el.branch, '— เลือกสาขา —');
      if (!pv) return;
      setLoading(true);
      try {
        const districts = await apiGet({ action:'districts', province: pv });
        fillSelect(el.district, districts, '— เลือกอำเภอ —');
      } catch (e) { alert(e?.message || e); }
      finally { setLoading(false); }
    });

    el.district.addEventListener('change', async (e) => {
      const pv = el.province.value;
      const dt = e.target.value;
      resetSelect(el.subdistrict, '— เลือกตำบล —');
      resetSelect(el.branch, '— เลือกสาขา —');
      if (!dt) return;
      setLoading(true);
      try {
        const subdistricts = await apiGet({ action:'subdistricts', province: pv, district: dt });
        fillSelect(el.subdistrict, subdistricts, '— เลือกตำบล —');
      } catch (e) { alert(e?.message || e); }
      finally { setLoading(false); }
    });

    el.subdistrict.addEventListener('change', async (e) => {
      const pv = el.province.value;
      const dt = el.district.value;
      const sb = e.target.value;
      resetSelect(el.branch, '— เลือกสาขา —');
      if (!sb) return;
      setLoading(true);
      try {
        const branches = await apiGet({ action:'branches', province: pv, district: dt, subdistrict: sb });
        fillSelect(el.branch, branches, '— เลือกสาขา —');
      } catch (e) { alert(e?.message || e); }
      finally { setLoading(false); }
    });

    /* ===== Submit ===== */
    el.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(el.form);
      const payload = {
        fullName: formData.get('fullName')?.trim(),
        contractNo: formData.get('contractNo')?.trim(),
        phone: formData.get('phone')?.trim(),
        province: el.province.value,
        district: el.district.value,
        subdistrict: el.subdistrict.value,
        branch: el.branch.value,
        preferredDt: formData.get('preferredDt')
      };

      // ตรวจวัน/เวลาอนาคต + เบอร์ + ตัวเลือกให้ครบ
      const chosen = new Date(payload.preferredDt);
      if (isNaN(chosen.getTime()) || chosen < new Date()) { alert('กรุณาเลือกวัน/เวลาตั้งแต่ปัจจุบันเป็นต้นไป'); return; }
      if (!payload.phone || payload.phone.replace(/\D/g,'').length < 9) { alert('กรุณากรอกเบอร์โทรให้ถูกต้อง'); return; }
      if (!payload.province || !payload.district || !payload.subdistrict || !payload.branch) { alert('กรุณาเลือกจังหวัด/อำเภอ/ตำบล/สาขาให้ครบถ้วน'); return; }

      setLoading(true);
      try {
        const res = await apiPost(payload);
        if (res?.ok) {
          alert('บันทึกสำเร็จ ขอบคุณค่ะ/ครับ');
          el.form.reset(); setMinDateNow();
          resetSelect(el.district, '— เลือกอำเภอ —');
          resetSelect(el.subdistrict, '— เลือกตำบล —');
          resetSelect(el.branch, '— เลือกสาขา —');
        } else {
          alert(res?.error || 'เกิดข้อผิดพลาด');
        }
      } catch (e) {
        alert('บันทึกไม่สำเร็จ: ' + (e?.message || e));
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
